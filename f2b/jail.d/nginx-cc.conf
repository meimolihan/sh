# ==============================================
# fail2ban jail 配置详解（中文注释版）
# 文件名：/etc/fail2ban/jail.local
# 适用：Debian 12 + Nginx + 自定义端口 666,80,443
# ==============================================

[DEFAULT]
# 全局缺省值，可被下方单个 jail 覆盖 ----------------
# 在「findtime」这段时间内累计失败 3 次才触发封禁
maxretry   = 3
findtime   = 300
bantime    = 3600
# 或 backend = auto
# backend = pyinotify 就是让 Fail2Ban 用“文件系统事件”方式实时 tail 日志，不漏、不延迟、不轮询。
backend = pyinotify 
# 永久豁免 10.10.10.0/24，让 Fail2Ban 永远不对该网段下手。
ignoreip = 127.0.0.0/8 ::1 10.10.10.0/24

# 累犯（recidive）增量封禁 ----------------------------
bantime.increment = true
bantime.factor    = 1
bantime.maxtime   = 2592000
bantime.multipliers = 1 4 16 64

# -------------------------------------------------
# 以下每个 [xxx] 都是一个独立 jail（监牢）
# 只要 enabled = true 就会被 fail2ban 加载
# -------------------------------------------------

[fail2ban-nginx-cc]
enabled  = true
filter   = fail2ban-nginx-cc
port     = 666,80,443
logpath  = /var/log/nginx/access.log

[nginx-418]
enabled  = true
filter   = nginx-418
port     = 666,80,443
logpath  = /var/log/nginx/access.log

[nginx-bad-request]
enabled  = true
filter   = nginx-bad-request
port     = 666,80,443
logpath  = /var/log/nginx/access.log

[nginx-badbots]
enabled  = true
filter   = apache-badbots
port     = 666,80,443
logpath  = /var/log/nginx/access.log

# 扫描 /admin/、/wp-admin/ 等敏感路径
[nginx-botsearch]
enabled  = true
filter   = nginx-botsearch
port     = 666,80,443
logpath  = /var/log/nginx/error.log

[nginx-deny]
enabled  = true
filter   = nginx-deny
port     = 666,80,443
logpath  = /var/log/nginx/error.log

# Basic Auth 401 暴力破解
[nginx-http-auth]
enabled  = true
filter   = nginx-http-auth
port     = 666,80,443
logpath  = /var/log/nginx/error.log

[nginx-unauthorized]
enabled  = true
filter   = nginx-unauthorized
port     = 666,80,443
logpath  = /var/log/nginx/access.log

# 拦截 ?url=http://... 类 RFI 攻击
[php-url-fopen]
enabled  = true
filter   = php-url-fopen
port     = 666,80,443
logpath  = /var/log/nginx/access.log

# 拦截 403
[nginx-403]
enabled  = true
filter   = nginx-403
port     = 666,80,443
logpath  = /var/log/nginx/access.log

[nginx-pve]
enabled  = true
filter   = nginx-pve
port     = 8006,666,80,443
logpath  = /var/log/nginx/access.log


# -------------------------------------------------
# [recidive] 累犯监狱：对“短时间内多次被其他监狱解封后仍继续攻击”的 IP 实施永久封禁
# 读取源：/var/log/fail2ban.log（其他监狱的 ban/unban 记录）
# 触发条件：1 天内（findtime=86400）出现过 1 次（maxretry=1）ban→unban→又 ban 的情况
# 动作：调用 iptables-allports 封掉该 IP 所有端口，bantime=-1 表示永久
# -------------------------------------------------
# 常用命令：
# 检查配置   : sudo fail2ban-client -t
# 重载配置   : sudo systemctl reload fail2ban
# 查看状态   : sudo fail2ban-client status recidive
# 手工封 IP  : sudo fail2ban-client set recidive banip  <IP>
# 手工解 IP  : sudo fail2ban-client set recidive unbanip<IP>
# -------------------------------------------------
[recidive]
enabled  = true
filter   = recidive
logpath  = /var/log/fail2ban.log
action = iptables-allports[name=recidive, protocol=all, blocktype=DROP]
findtime = 86400  ; 1天（以秒为单位）
maxretry = 1      ; 使用 maxretry 而不是 maxmatches
bantime  = -1     ; 永久封禁


