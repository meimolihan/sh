# 全局配置块 - 影响 Nginx 整体运行的基础配置
#######################################################################

# 指定Nginx运行的系统用户身份
user www-data;

# 工作进程数，设为auto可自动根据CPU核心数调整，充分利用硬件资源
worker_processes auto;

# Nginx进程PID文件存放路径
pid /run/nginx.pid;

# 错误日志存放路径
error_log /var/log/nginx/error.log;

# 调整每个工作进程可打开的最大文件描述符数量，提升并发处理能力
worker_rlimit_nofile 65535;


# 事件处理配置块 - 定义网络连接相关的处理策略
#######################################################################
events {
    # 每个工作进程的最大并发连接数，根据系统资源调整
    worker_connections 65535;
    
    # 采用epoll事件模型（适用于Linux系统，提升IO效率）
    use epoll;
    
    # 允许一个事件周期内接受多个连接请求，提高连接建立效率
    multi_accept on;
}


# HTTP核心配置块 - 定义HTTP服务器的主要行为和参数
#######################################################################
http {
    # 高效传输配置
    ###########################################################
    sendfile on;                  # 启用高效文件传输模式
    tcp_nopush on;                # 启用TCP无推送模式，减少网络碎片
    tcp_nodelay on;               # 启用TCP_NODELAY，降低交互延迟
    server_names_hash_bucket_size 128; #服务器名字的 hash 表大小
    client_header_buffer_size 32k; #上传文件大小限制

    # 连接保持配置
    ###########################################################
    keepalive_timeout 120;           # HTTP长连接超时时间（秒）
    keepalive_requests 200;          # 单个长连接允许的最大请求数
    client_header_timeout 10;        #客户端请求头的超时时间
    client_body_timeout 10;          #客户端请求主体超时时间
    reset_timedout_connection on;    #告诉 nginx 关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空间
    send_timeout 10;                 #客户端响应超时时间，在两次客户端读取操作之间。如果在这段时间内，客户端没有读取任何数据，nginx 就会关闭连接


    # MIME类型与请求限制
    ###########################################################
    types_hash_max_size 2048;               # 类型文件哈希表大小，加速MIME类型判断
    client_max_body_size 1024m;              # 限制客户端请求体最大大小
    include /etc/nginx/mime.types;          # 引入MIME类型映射表
    default_type application/octet-stream;  # 默认MIME类型


    # SSL/TLS安全配置
    ###########################################################
    ssl_prefer_server_ciphers on;                 # 优先使用服务器指定的加密套件
    ssl_session_cache shared:SSL:10m;             # SSL会话缓存（共享内存，10MB）
    ssl_session_timeout 5m;                       # SSL会话超时时间
    ssl_protocols TLSv1.2 TLSv1.3;                # 支持的TLS协议版本（禁用不安全的旧版本）
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';  # 加密套件（优先选择安全且高效的）


    # 日志配置
    ###########################################################
    # 定义日志格式
    # log_format mobufan_log '客户端IP: [$remote_addr] 访问时间: [$time_local] 来源: [$http_referer] 请求行: [$request] \n'
    #                       '状态码: [$status] 发送字节: [$body_bytes_sent] 用户代理: [$http_user_agent]\n';
    # access_log /var/log/nginx/access.log mobufan_log;  # 访问日志存放路径

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"\n';

    access_log  /var/log/nginx/access.log main buffer=512k flush=10s; # 访问日志存放路径



    # Gzip压缩配置
    ###########################################################
    gzip on;                          # 启用Gzip压缩
    gzip_static on;                   # 支持预压缩的静态文件（.gz）
    gzip_min_length 1k;               # 最小压缩文件大小（小于此值不压缩）
    gzip_buffers 4 16k;               # 压缩缓冲区（4个16KB缓冲区）
    gzip_http_version 1.1;            # 支持的HTTP协议版本
    gzip_comp_level 5;                # 压缩级别（1-9，5为平衡值）
    gzip_vary on;                     # 响应头添加Vary: Accept-Encoding，支持代理缓存
    gzip_disable "MSIE [1-6]\.";      # 禁用IE6及以下版本的压缩支持
    gzip_proxied any;                 # 对所有代理请求启用压缩
    gzip_types                        # 需要压缩的MIME类型
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        application/atom+xml
        application/geo+json
        application/rss+xml
        application/vnd.ms-fontobject
        font/opentype
        image/svg+xml
        text/javascript
        application/x-javascript
        application/xhtml+xml;


    # FastCGI代理配置（适用于PHP等后端）
    ###########################################################
    fastcgi_connect_timeout 300;       # 连接FastCGI超时时间
    fastcgi_send_timeout 300;          # 发送数据到FastCGI超时时间
    fastcgi_read_timeout 300;          # 从FastCGI读取数据超时时间
    fastcgi_buffer_size 128k;          # FastCGI缓冲区大小
    fastcgi_buffers 4 128k;            # FastCGI缓冲区数量和大小
    fastcgi_busy_buffers_size 256k;    # 忙碌状态下的缓冲区大小
    fastcgi_temp_file_write_size 256k; # 临时文件写入大小
    fastcgi_intercept_errors on;       # 拦截FastCGI错误页面，避免暴露细节


    # 安全防护头配置
    ###########################################################
    add_header X-Content-Type-Options nosniff always;          # 防止MIME类型混淆攻击
    add_header X-XSS-Protection "1; mode=block" always;        # 启用XSS过滤
    add_header X-Frame-Options SAMEORIGIN always;              # 防止点击劫持
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;  # HSTS


    # 安全与隐藏信息配置
    ###########################################################
    autoindex on;                     # 开启目录列表访问，合适下载服务器，默认关闭。
    server_tokens off;                # 隐藏Nginx版本号
    proxy_hide_header X-Powered-By;   # 隐藏后端程序版本（如PHP）
    proxy_hide_header Server;         # 隐藏代理服务器标识
    proxy_buffer_size 128k;           # 代理缓冲区大小
    proxy_buffers 4 256k;             # 代理缓冲区数量和大小
    proxy_busy_buffers_size 256k;     # 代理忙碌状态下的缓冲区大小
    

    # 防DDoS配置
    ###########################################################
    limit_conn_zone $binary_remote_addr zone=addr:10m;  # 定义IP连接限制的共享内存区域
    limit_conn_zone $binary_remote_addr zone=perip:10m; # 新增：为server块中的限制定义区域
    limit_conn addr 100;                                # 限制单个IP最大并发连接数


    # 文件缓存配置
    ###########################################################
    open_file_cache max=1000 inactive=20s;  # 缓存打开的文件描述符（最多1000个，20秒无活动失效）
    open_file_cache_valid 30s;              # 验证缓存有效性的时间间隔
    open_file_cache_min_uses 2;             # 最少使用2次才会被缓存
    open_file_cache_errors on;              # 缓存文件错误信息

    # 设置默认字符集
    charset utf-8;

    # 站点配置与错误页面
    ###########################################################
    include /etc/nginx/conf.d/*.conf;  # 包含所有已启用的站点配置文件
    include /etc/nginx/dpdns.org/*.conf;
    include /etc/nginx/sites-enabled/*;

    # 自定义错误页面
    root /etc/nginx/html;     # 全局网站根目录
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
